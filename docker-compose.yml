version: '3.8'

services:
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    network_mode: host
    environment:
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://localhost:5678/
      - GENERIC_TIMEZONE=Europe/Berlin
      - N8N_LOG_LEVEL=info
      # Allow n8n to execute commands and workflows with full permissions
      - N8N_RUNNERS_ENABLED=true
    volumes:
      # n8n data persistence (workflows, credentials, settings)
      - ./n8n-data:/home/node/.n8n
      # Mount home directory for file operations in workflows
      - /home/goodmoodlab:/host-home
    user: "1000:1000"

  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    network_mode: host
    volumes:
      # Central AI models storage - shared across all applications
      - ./ai-models:/root/.ollama
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  open-webui:
    image: ghcr.io/open-webui/open-webui:ollama
    container_name: open-webui-new
    restart: unless-stopped
    ports:
      - "12000:8080"
    environment:
      - OLLAMA_BASE_URL=http://localhost:11434
    volumes:
      # Application data (chats, settings, etc)
      - open-webui:/app/backend/data
      # Central AI models storage - shared with standalone Ollama
      - ./ai-models:/root/.ollama
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  streetview-capture:
    build:
      context: ./streetview-automation
      dockerfile: Dockerfile
    container_name: streetview-capture
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - TZ=Europe/Berlin
      - OUTPUT_DIR=/app/screenshots
      # X11 display configuration for visible browser mode
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
    volumes:
      # Shared screenshots folder accessible from host and n8n
      - ./streetview-screenshots:/app/screenshots
      # X11 socket for visible browser mode (headless: false)
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
    shm_size: 2gb
    # Allow X11 IPC communication
    ipc: host
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3

  postgres:
    image: postgres:16-alpine
    container_name: postgres
    restart: unless-stopped
    network_mode: host
    environment:
      - POSTGRES_USER=imageprocessor
      - POSTGRES_PASSWORD=securepassword123
      - POSTGRES_DB=streetview_analysis
      - PGDATA=/var/lib/postgresql/data/pgdata
      - TZ=Europe/Berlin
    volumes:
      - ./postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U imageprocessor -d streetview_analysis"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  image-processor:
    build:
      context: ./image-processor
      dockerfile: Dockerfile
    container_name: image-processor
    restart: unless-stopped
    network_mode: host
    environment:
      - DATABASE_URL=postgresql://imageprocessor:securepassword123@localhost:5432/streetview_analysis
      - OLLAMA_BASE_URL=http://localhost:11434
      - OLLAMA_MODEL=llava:13b
      - INPUT_DIR=/app/input
      - OUTPUT_DIR=/app/output
      - TZ=Europe/Berlin
    volumes:
      # Read-only access to captured screenshots
      - ./streetview-screenshots:/app/input:ro
      # Write access for analysis results
      - ./processed-results:/app/output
    depends_on:
      postgres:
        condition: service_healthy
      ollama:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  adminer:
    image: adminer:latest
    container_name: adminer
    restart: unless-stopped
    network_mode: host
    environment:
      - ADMINER_DEFAULT_SERVER=localhost
      - ADMINER_DESIGN=nette
      - TZ=Europe/Berlin

volumes:
  open-webui:
